This folder contains a sample project for using the [ILI9488 TFT display library](https://github.com/viktor-nikolov/ILI9488-Xilinx) on the [MicroBlaze](https://www.xilinx.com/products/design-tools/microblaze.html) soft CPU using SRAM on the [Cmod A7-35T](https://digilent.com/shop/cmod-a7-35t-breadboardable-artix-7-fpga-module/) board.

The design was made in Vivado 2023.1 and Vitis 2023.1.

## HW design

HW design for the [Cmod A7-35T](https://digilent.com/shop/cmod-a7-35t-breadboardable-artix-7-fpga-module/) was quite straightforward, thanks to the board files provided by Digilent.

I chose the button BTN0 as a reset button. BTN0 is a regular button, and it, therefore, generates a reset signal "active high."  
I selected output pins on the board for display connection signals in a way to make breadboard connections as easy as possible.  
I uncommented and renamed the chosen pins in the Cmod A7 [Master XSD file](https://github.com/Digilent/digilent-xdc/blob/master/Cmod-A7-Master.xdc) and created the ports in the diagram. Note that the system clock on the Cmod A7 has a frequency of 12 MHz.

I dragged the "Cell RAM" and "USB UART" components from the Board window onto the Block Diagram. This created AXI EMC (External Memory Controller) and AXI UART Lite IPs and relevant ports.  
Then, I manually created AXI GPIO and AXI Quad SPI IPs and added the MicroBlaze. Vivado connection automation then did the vast majority of connections, including the creation of AXI Interconnect and AXI SmartConnect IPs.

In the Address Editor, I must manually change the size of /axi_emc_0/S_AXI_MEM to 512K (note that axi_emc_0 appears twice in the Address Editor list).

The MicroBlaze and all peripherals are clocked on 100 MHz generated by the Clocking Wizard.  
My attempts to try a higher clock were not successful. 100 MHz is the highest clock, which produces a stable design. I guess that the speed of SRAM used on the board is a limiting factor.

Clocking Wizard's clk_out2 is the 40 MHz clock needed for the ext_spi_clk input signal of the AXI Quad SPI IP. The Frequency Ratio of the AXI SPI IP is set to 2. This results in the desired 20 MHz SPI clock for the display.

> [!NOTE]
> It was important to set the Source to "No Buffer" in the Input Clock Information in the Clocking Wizard configuration.  
> Without the "No Buffer" setting, I was getting strange timing requirements warnings. In fact, we have no buffer between the input clock pin and the Clocking Wizard.

The AXI GPIO IP is configured to provide two output GPIO signals, which are used as RST and DC signals for the display.  
The two Slices are used solely for "aesthetic purposes", so the RST and DC pins can be scalar pins in the diagram.

The performance of an app running on MicroBlaze is totally dependent on the amount of instruction and data cache you can provide to the processor. Make it as big as possible. The cache in FPGA's local memory is tremendously faster than the SRAM.  
I configured the Microblaze with 16kB of Instruction Cache and 32kB of Data Cache.

I configured the MicroBlaze with 16kB of local memory even though the application will run from the 512 KB SRAM. This is for future use. When you decide to load the FPGA configuration and MicroBlaze app from the flash (like on a production device), you will need the local memory to store the MicroBlaze bootloader, which will load the app from the flash to DDR3 memory. See this tutorial on the topic: [Flashing a MicroBlaze Program](https://www.instructables.com/Flashing-a-MicroBlaze-Program).

[<img src="https://github.com/viktor-nikolov/ILI9488-Xilinx/blob/main/pictures/MicroBlaze_SRAM_AXI-GPIO_AXI-SPI_diagram.png?raw=true" title="" alt="">](https://github.com/viktor-nikolov/ILI9488-Xilinx/blob/main/pictures/MicroBlaze_SRAM_AXI-GPIO_AXI-SPI_diagram.png)

## Application setup in Vitis

In the C/C++ Build Settings, I set Optimization to "Optimize most (-O3)". The default optimization setting was -O2.

We have 512 KB of SRAM at our disposal (however, 229 KB is consumed by the code of the demo application).  I increased the Stack Size from the default 1 KB to 8 KB and the Heap Size from the default 2 KB to 16 KB in lscript.ld.

Increasing the Stack Size from the MicroBlaze's default 1 KB is important.  
The method ILI9488::fillRect uses 768 B from the stack for a local array, which is used to prepare data to be sent to the display over SPI.  
The [demo application](../../ILI9488-Xilinx_library_demo_app) used in this project works with a 1 KB stack size, but more complex applications may not.

> [!NOTE]
> Having only 512 KB of SRAM on Cmod A7 significantly limits our ability to work with larger RGB bitmaps on this platform.  
> The size of the demo application is 229 KB (which includes 19 KB of a small demo RGB bitmap [Sun_png_image888](../../ILI9488-Xilinx_library_demo_app/demo_image2.h)). That leaves 283 KB available. The demo application on Cmod A7, therefore, can't display from memory a full-screen bitmap 480x320 because that is 300 KB big (in the color coding R:G:B 5b:6b:5b).

## The physical connection of the display

For connecting the display I selected the Cmod A7 pins close to the Pmod connector.  
I recommend using ground from the ground pin No. 25 of the Cmod A7.  
3.3 V power is available only on the Pmod pins 6 and 12.

The following images describe the connection and provide the pin numbers of the Cmod A7.

> [!CAUTION]
>
> Do not use VU pin No. 24 on the Cmod A7 for powering the display. This pin is connected to 5 V coming via the USB. 5 V will very likely fry your ILI9488 display and could damage the Cmod A7 FPGA.

[<img src="https://github.com/viktor-nikolov/ILI9488-Xilinx/blob/main/pictures/CmodA7_connection_schematics.png?raw=true" title="" alt="" width="600">](https://github.com/viktor-nikolov/ILI9488-Xilinx/blob/main/pictures/CmodA7_connection_schematics.png)

[<img src="https://github.com/viktor-nikolov/ILI9488-Xilinx/blob/main/pictures/cmoda7_b_dip.png?raw=true" title="" alt="" width="180">](https://github.com/viktor-nikolov/ILI9488-Xilinx/blob/main/pictures/cmoda7_b_dip.png)  
&nbsp; 

[<img src="https://github.com/viktor-nikolov/ILI9488-Xilinx/blob/main/pictures/ILI9488_with_Cmod_A7.jpg?raw=true" title="" alt="" width="500">](https://github.com/viktor-nikolov/ILI9488-Xilinx/blob/main/pictures/ILI9488_with_Cmod_A7.jpg)