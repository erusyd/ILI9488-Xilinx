# ILI9488 library on MicroBlaze (AXI GPIO, AXI SPI, DDR3 SDRAM)

This folder contains a sample project for using the [ILI9488 TFT display library](https://github.com/viktor-nikolov/ILI9488-Xilinx) on the [MicroBlaze](https://www.xilinx.com/products/design-tools/microblaze.html) soft CPU using DDR3 SDRAM.

The design was made in Vivado 2023.1 and Vitis 2023.1 and tested on [Arty A7-35T](https://digilent.com/shop/arty-a7-100t-artix-7-fpga-development-board/) (this variant 35T is no longer in production).

> [!IMPORTANT]
> **If you have Arty A7-100T**, you must change the board to A7-100T in Vivado in Tools|Settings|General|Project device.  
> No other changes in the design should be necessary.
>
> Generate the bitstream and export HW (File|Export|Export Hardware, select "Include Bitstream").  
> Then, in Vitis, you right-click the "system" project in the Explorer, select "Update Hardware Specification" and specify the .xsa file generated by Vivado. With the HW specification updated, you must re-build all projects in the Vitis workspace.

## HW design

I followed the steps of my [MicroBlaze with DDR3 SDRAM tutorial](https://github.com/viktor-nikolov/MicroBlaze-DDR3-tutorial) for the basis of this HW design. I, of course, added an AXI Quad SPI IP.

During testing of the library on this HW design, I faced occasional glitches in SPI communication. I discovered that the reason for these glitches was too high clock frequency of the MicroBlaze, AXI bus and AXI SPI IP.

I achieved a reliable operation with the MicroBlaze clocked at 160 MHz and the AXI bus with the peripherals clocked at 120 MHz.  
This is consistent with the information in the AXI Quad SPI [Product Guide PG153](https://docs.xilinx.com/r/en-US/pg153-axi-quad-spi), which states in the chapter [Performance](https://docs.xilinx.com/r/en-US/pg153-axi-quad-spi/Performance) that the maximum AXI-Lite frequency for this IP is 120 MHz on the slowest speed grade of Artix-7 (i.e., the IC used on Arty A7).

The final design presented here uses a single Clocking Wizard, which produces four clocks:

- clk_out1 is the 160 MHz clock for the MicroBlaze and Slave interfaces on the AXI Interconnects (i.e., the interfaces exposed towards the MicroBlaze).
- clk_out2 is the 40 MHz clock needed for the ext_spi_clk input signal of the AXI Quad SPI IP. The Frequency Ratio of the AXI SPI IP is set to 2. This results in the desired 20 MHz SPI clock for the display.
- clk_out3 is the 120 MHz clock for the Master interfaces of the perif_interconnect and for AXI GPI, AXI UART Lite and AXI Quad SPI IPs.  
  (The master interface of the ram_interconnect is clocked by the 81.25 MHz ui_clk output clock of the MIG.)
- clk_out4 is the 200 MHz clock needed for the MIG clk_ref_i input clock.

I selected Pmod JD on the Arty A7 to connect the display. JD is a so-called standard Pmod (see details in the Arty A7 [Reference Manual](https://digilent.com/reference/programmable-logic/arty-a7/reference-manual?redirect=1#pmod_connectors)).

The AXI GPIO IP is configured to provide two output GPIO signals, which are used as RST and DC signals for the display.  
The two Slices are used solely for "aesthetic purposes", so the RST and DC pins can be scalar pins in the diagram.  
&nbsp;

[<img src="https://github.com/viktor-nikolov/ILI9488-Xilinx/blob/main/pictures/MicroBlaze_DDR3_AXI-GPIO_AXI-SPI_diagram.png?raw=true" title="" alt="">](https://github.com/viktor-nikolov/ILI9488-Xilinx/blob/main/pictures/MicroBlaze_DDR3_AXI-GPIO_AXI-SPI_diagram.png)

> [!NOTE]
> After the implementation step in Vivado, you will see a critical warning: "[Timing 38-282] The design failed to meet the timing requirements." The reason is negative setup slack on the intra-clock paths of signals within the MicroBlaze.
>
> It is generally bad to have a negative setup slack. The design presented here worked well in all my tests, but we are "pushing our luck".
>
> MicroBlaze Reference Guide [UG984](https://docs.xilinx.com/v/u/en-US/ug984-vivado-microblaze-ref) says in [Table A-1](https://docs.xilinx.com/pdf-viewer?file=https%3A%2F%2Fdocs.xilinx.com%2Fapi%2Fkhub%2Fdocuments%2Fb4L~AnnQ0FpZ9cXl7XWkdA%2Fcontent%3FFt-Calling-App%3Dft%252Fturnkey-portal%26Ft-Calling-App-Version%3D4.2.26%26filename%3Dug984-vivado-microblaze-ref.pdf#G8.235415), that max. frequency of MicroBlaze on Artix 7 (the chip used on the Arty A7 board) is 267 MHz. However, 267 MHz is probably a best-case scenario with MicroBlaze of minimum complexity (no caches, all options set to minimum).  
> Nevertheless, the 160 MHz I used in this design does not seem to be in an "overclocking range".
>
> If you want to be 100% on the safe side, reduce the MicroBlaze clock clk_wiz_0.clk_out1 and peripherals clock clk_out3 to 100 MHz. All timing warnings will disappear, and all slacks will be positive as they should.

## Application setup in Vitis

In the C/C++ Build Settings, I set Optimization to "Optimize most (-O3)". The default optimization setting was -O2.

We have 256 MB of DDR3 SDRAM at our disposal, so I increased the Stack Size from the default 1 kB to 16 kB and the Heap Size from the default 2 kB to 32 kB.

Increasing the Stack Size from the MicroBlaze's default 1 kB is important.  
The method ILI9488::fillRect uses 768 B from the stack for a local array, which is used to prepare data to be sent to the display over SPI.  
The [demo application](../../ILI9488-Xilinx_library_demo_app) used in this project works with a 1 kB stack size, but more complex applications may not.

## The physical connection of the display

[<img src="https://github.com/viktor-nikolov/ILI9488-Xilinx/blob/main/pictures/ArtyA7_connection_schematics.png?raw=true" title="" alt="" width="600">](https://github.com/viktor-nikolov/ILI9488-Xilinx/blob/main/pictures/ArtyA7_connection_schematics.png)

[<img src="https://github.com/viktor-nikolov/ILI9488-Xilinx/blob/main/pictures/ILI9488_with_Arty_A7.jpg?raw=true" title="" alt="" width="600">](https://github.com/viktor-nikolov/ILI9488-Xilinx/blob/main/pictures/ILI9488_with_Arty_A7.jpg)

